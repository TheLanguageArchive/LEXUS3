<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml"
				layout="vertical"
				creationComplete="init()"
				title="Import Lexus XML files"
				showCloseButton="true"
				width="800" height="370" y="50"
				close="close();" xmlns:local="*">
<mx:Script>
	<![CDATA[
		import com.adobe.net.URI;
		import com.adobe.serialization.json.JSON;
		
		import mx.collections.ArrayCollection;
		import mx.managers.PopUpManager;
		import mx.rpc.events.ResultEvent;
		import mx.utils.ArrayUtil;
		
		import nl.mpi.lexus.LexusUtil;
		import nl.mpi.lexus.YesNo;
		import nl.mpi.lexus.service.LexusService;
		import nl.mpi.lexus.event.NewLexiconEvent;
		
		private var urlRequest:URLRequest;
		[Bindable] private var typFileReference:FileReference;
		[Bindable] private var dataFileReference:FileReference;

		private var params:Object; // For sending the remote IDs to the converter
		private var popupDownloadConverted:FileDownloadBoxWithStartButton; // Used to download the converted toolbox files, after uploads are done.

		[Bindable] public var sessionId:String;
		
		
				
		private function init():void {
			params = new Object();
		}
		
		private function close():void {
			PopUpManager.removePopUp(this);
		}
		
		/*
		 * Delegate methods for UploadTwoFiles.
		 */
		
		public function getTitle(utf:UploadTwoFiles, fileNumber:int):String {
			return fileNumber == 1
				? "Select the file containing the structure of the lexicon"
				: "Select the file containing the data of the lexicon";
		}
		
		public function getBrowseTitle(utf:UploadTwoFiles, fileNumber:int):String {
			return fileNumber == 1
				? "Browse for .xml file"
				: "Browse for .xml file";
		}
		
		/*
		 * Get filefilter for browsing first file.
		 */
		public function getFilter1(utf:UploadTwoFiles):FileFilter
		{
			return new FileFilter("Toolbox", "*.xml");
		}
		/*
		 * Get filefilter for browsing second file.
		 */
		public function getFilter2(utf:UploadTwoFiles):FileFilter
		{
			return new FileFilter("Toolbox", "*.xml");
		}
		
		/*
 		 * Return false if upload cannot start, true otherwise.
		 * Additional actions can be taken.
		 */
		public function uploadCanStart(utf:UploadTwoFiles, file_1_Reference:FileReference, file_2_Reference:FileReference):Boolean
		{
			try {
				if (file_1_Reference.name && file_2_Reference.name) {
					//popupDownloadConverted = FileDownloadBoxWithStartButton(PopUpManager.createPopUp(this, FileDownloadBoxWithStartButton, false));
					//PopUpManager.centerPopUp(popupDownloadConverted);
					return true;
				}
			} catch (error:Error) { // Skipping this 'cos both files must be selected first.
				YesNo.alert("Please select the .xml files first.");
				return false;
			}
			return false;
		}
		
		/*
		 * Get URLRequest object for specified file.
		 */
		public function getURLRequest(utf:UploadTwoFiles, fileNumber:int, file_Reference:FileReference):URLRequest {
			return new URLRequest(LexusService.getAbsoluteURL("StagingFileHandler/uploadFile.xml;jsessionid=" + this.sessionId));
		}
		
		public function uploadFile1Completed(utf:UploadTwoFiles, data:XML):void {
			params.typFileId = data.Filedata;
		}
		public function uploadFile2Completed(utf:UploadTwoFiles, data:XML):void {
			params.dataFileId = data.Filedata;
		}
		public function finished(utf:UploadTwoFiles):void {
			LexusUtil.showWait(this, "Importing lexicon");
			var ls:LexusService = new LexusService();
			ls.getXML("LexusWorkspaceEditor/import/"+params.typFileId+"/"+params.dataFileId+"/ImportLexusXML.xml", importFinished);
		}
		
		private function importFinished(event:ResultEvent):void {
			LexusUtil.parseXML(String(event.result),
				function(data:XML):void {
					if (data.@success == 'true') {
						var lexicon:Object = data.result.lexicon;
						var evt:Event = new NewLexiconEvent("new", lexicon);
						YesNo.info("Import succeeded.");
					}
					else {
						YesNo.alert("Import failed. Server reports: " + data.message);
					}
					LexusUtil.removeWait();
				}
			);
		}
	]]>
</mx:Script>
	<local:UploadTwoFiles id="utf" delegate="{this}"/>
</mx:TitleWindow>
